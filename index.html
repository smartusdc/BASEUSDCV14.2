<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="BASEUSDC.COM - The premier USDC staking platform on Base Network offering 74% APR, instant withdrawals, and secure staking. Start earning high yields on your USDC today with no minimum lock period.">
<meta name="keywords" content="USDC staking, Base Network, Coinbase, crypto yield, DeFi staking, USDC yield farming, instant withdrawals, high APR">
<meta property="og:title" content="BASEUSDC.COM - Earn High Yields with USDC on Base Network">
<meta property="og:description" content="Earn 74% APR on your USDC with instant withdrawals and no minimum lock period on Coinbase's BASE Network. Safe, secure, and efficient staking platform.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://baseusdc.com">
<meta property="og:site_name" content="BASEUSDC.COM">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="BASEUSDC.COM - 74% APR USDC Staking on Base Network">
<meta name="twitter:description" content="Start earning high yields on your USDC today with instant withdrawals and no minimum lock period on Coinbase's BASE Network.">
<meta name="robots" content="index, follow">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<link rel="icon" type="image/png" href="/favicon.png">
<link rel="apple-touch-icon" href="/favicon.png">
<meta name="theme-color" content="#2196F3">
  <title>BASEUSDC.COM - Earn High Yields with USDC on Base Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.10.0/web3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            background: #fff;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
            border: 1px solid #e9ecef;
        }
        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
            transition: all 0.2s ease-in-out;
        }
        .button:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button:active {
            transform: translateY(0);
        }
        .button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .button.secondary {
            background: #2196F3;
        }
        .button.secondary:hover {
            background: #1e88e5;
        }
        .input-group {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: stretch;
        }
        .input-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            min-width: 200px;
        }
        .input-wrapper input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .input-wrapper input.with-max {
            padding-right: 60px;
        }
        .input-wrapper input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        .max-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .max-button:hover {
            background: #1e88e5;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stats .card h3 {
            color: #2196F3;
            margin-bottom: 15px;
        }
        .stats .card p {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .stats .card p:last-child {
            border-bottom: none;
        }
        .stats .card span:last-child {
            font-weight: 500;
            color: #2196F3;
        }
        .alert {
            padding: 14px;
            border-radius: 6px;
            margin: 12px 0;
            display: none;
            font-size: 14px;
            line-height: 1.5;
            transition: opacity 0.3s ease-in-out;
        }
        .alert.success {
            background: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .alert.error {
            background: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }
        #mainContent {
            display: none;
        }
        .network-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
        }
        .network-status.wrong {
            background: #ffebee;
            color: #c62828;
        }
        .network-status.correct {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .debug-info {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
            font-size: 12px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }
        .platform-info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem 2rem;
            margin: 1rem 0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 2rem;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease-in-out;
        }
        .platform-info-card:hover {
            transform: translateY(-2px);
        }
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 150px;
        }
        .info-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.3rem;
        }
        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
        }
        .referral-section {
            position: relative;
            display: inline-block;
        }
        .referral-status {
            font-size: 0.9em;
            margin-left: 8px;
            color: #4CAF50;
        }
        .referral-status.active {
            display: inline-block;
            padding: 2px 6px;
            background: #e8f5e9;
            border-radius: 4px;
            color: #2e7d32;
        }
        @media (max-width: 768px) {
            .platform-info-card {
                padding: 1rem;
            }
            .info-item {
                min-width: 120px;
            }
            .info-value {
                font-size: 1.2rem;
            }
        }
    
        /* 既存のstyleタグ内に追加 */
.features-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    padding: 40px 0;
}
.feature-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.feature-card h3 {
    color: #1a237e;
    margin-bottom: 15px;
}
        .hero-section {
    text-align: center;
    padding: 60px 20px;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
    border-radius: 15px;
    margin: 20px 0;
}
.hero-title {
    font-size: 2.5em;
    color: #1a237e;
    margin-bottom: 15px;
}
.hero-subtitle {
    font-size: 1.2em;
    color: #424242;
    margin-bottom: 30px;
}
   .faq-section {
    margin: 40px 0;
}
.faq-item {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 10px;
}     
        .creators-section {
    padding: 40px;
    margin: 40px 0;
    background: #f8f9fa;
    border-radius: 15px;
}
        .step-card {
    background: white;
    padding: 25px 25px 25px 35px;  /* 左側にステップ番号用のスペース */
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    margin-left: 20px;  /* ステップ番号のスペース */
    margin-bottom: 20px;
    transition: transform 0.3s ease;
}

.step-number {
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: #2196F3;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2em;
}

.step-card h3 {
    color: #1a237e;
    margin: 0 0 10px 0;
    font-size: 1.2em;
}

.step-card p {
    margin: 0;
    color: #666;
    line-height: 1.5;
}

.steps-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 30px;
    padding: 40px 0;
}
        /* ヘッダーロゴとスタイリングの追加 */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 0;
    margin-bottom: 2rem;
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.logo {
    height: 40px;
    width: auto;
}

.site-title {
    color: #1a237e;
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
}

@media (max-width: 768px) {
    .logo {
        height: 32px;
    }
    .site-title {
        font-size: 1.2rem;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
    <div class="logo-container">
        <img src="/logo.png" alt="BASEUSDC.COM" class="logo">
        <h1 class="site-title">BASEUSDC.COM</h1>
    </div>
    <div style="display: flex; align-items: center;">
        <span id="networkStatus" class="network-status"></span>
        <button id="connectWallet" class="button">Connect Wallet</button>
    </div>
</div>

        <div class="platform-info-card">
            <div class="info-item">
                <span class="info-label">Current APR</span>
                <span class="info-value"><span id="currentAPR">0</span>%</span>
            </div>
            <div class="info-item">
                <span class="info-label">Referrer Reward</span>
                <span class="info-value"><span id="referrerReward">0</span>%</span>
            </div>
            <div class="info-item">
                <span class="info-label">Referred Reward</span>
                <span class="info-value"><span id="referredReward">0</span>%</span>
            </div>
        </div>

        <div id="alert" class="alert"></div>
        <div id="loading" class="loading">Processing transaction...</div>
        <div id="debugInfo" class="debug-info"></div>
    <!-- 新規追加のランディングコンテンツ -->
    <div id="landingContent">
    
            <!-- ヒーローセクション -->
            <div class="hero-section">
                <h2 class="hero-title">Earn High Yields with USDC on Base Network</h2>
                <p class="hero-subtitle">74% APR USDC Staking Platform on Coinbase's BASE Network</p>
                 <p class="hero-subtitle">Safe • Instant Withdrawals • No Minimum Lock Period</p>
            </div>

            <!-- ステップセクション -->
            <div class="steps-section">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h3>Create Coinbase Account</h3>
                    <p>Start by creating a Coinbase account to purchase USDC. This is your gateway to cryptocurrency.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <h3>Setup Wallet</h3>
                    <p>Install MetaMask and purchase USDC from Coinbase. Transfer USDC to your MetaMask wallet.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <h3>Connect to BASE</h3>
                    <p>Switch to BASE Network using MetaMask. BASE is Coinbase's secure and efficient network.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">4</div>
                    <h3>Start Staking</h3>
                    <p>Connect wallet and start earning rewards. You can start with as little as $1 USDC.</p>
                </div>
            </div>

            <!-- 特徴セクション -->
            <div class="features-section">
                <div class="feature-card">
                    <h3>Security First</h3>
                    <p>Built on Coinbase's BASE Network, ensuring maximum security for your assets.</p>
                    <p>Transparent smart contracts that anyone can verify.</p>
                    <p>Free withdrawals available anytime without restrictions.</p>
                </div>
                <div class="feature-card">
                    <h3>High Yields</h3>
                    <p>Competitive APR rates that maximize your USDC earnings.</p>
                    <p>Additional referral rewards for community growth.</p>
                    <p>Future platform token rewards for early adopters.</p>
                </div>
                <div class="feature-card">
                    <h3>Easy to Start</h3>
                    <p>Begin with just $1 USDC to test the platform.</p>
                    <p>User-friendly interface for seamless staking.</p>
                    <p>Instant reward tracking and calculations.</p>
                </div>
            </div>

            <!-- FAQ セクション -->
            <div class="faq-section">
                <h2>Frequently Asked Questions</h2>
                <div class="faq-item">
                    <div class="faq-question">How safe is my investment?</div>
                    <div class="faq-answer">
                        Your funds are secured by smart contracts on the BASE Network, operated by Coinbase. All contracts are public and verifiable, ensuring complete transparency. We utilize only proven yield strategies to maintain security.
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">What are the platform tokens?</div>
                    <div class="faq-answer">
                        Early users of BASEUSDC.COM will receive platform tokens as a reward for their early support. These tokens will provide governance rights and additional benefits in the ecosystem. The earlier you join, the more tokens you can earn.
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">Can I withdraw anytime?</div>
                    <div class="faq-answer">
                        Yes, you can withdraw your funds at any time without any restrictions or fees. Your funds remain under your control, and withdrawals are processed immediately through our smart contracts.
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">How does the referral program work?</div>
                    <div class="faq-answer">
                        Share your referral code with others, and both you and your referrals earn extra rewards. You'll earn additional APR on referral's stakes, while they get a bonus APR too. It's a win-win situation that rewards community growth.
                    </div>
                </div>
            </div>
      

            <!-- コンテンツクリエイターセクション -->
            <div class="creators-section">
                <h2>Featured Content Creators</h2>
                <div class="creators-empty-state">
                    <p>Are you a content creator? Create a video or article about BASEUSDC.COM and get featured here!</p>
                    <p>Benefits of being featured:</p>
                    <ul>
                        <li>Direct exposure to our growing user base</li>
                        <li>Permanent backlink to your content</li>
                        <li>Special referral tracking</li>
                        <li>Priority support and early access to new features</li>
                        <li>Opportunity to be highlighted as a trusted community voice</li>
                    </ul>
                    <p>Contact us through our form to get your content featured. Quality content that helps users understand our platform will be prioritized for featuring.</p>
                </div>
            </div>

            <!-- フッター -->
           <div class="footer-links">
    <a href="mailto:support@baseusdc.com" class="footer-link">Need Support? Email us: support@baseusdc.com</a>
</div>
        </div>
           </div>
        <div id="mainContent">
            <div class="stats">
                <div class="card">
                    <h3>Your Statistics</h3>
                    <p>Available: <span id="userBalance">0</span> USDC</p>
                    <p>Staked: <span id="stakedAmount">0</span> USDC</p>
                    <p>Pending Rewards: <span id="pendingRewards">0</span> USDC</p>
                </div>
                <div class="card">
                    <h3>Referral Statistics</h3>
                    <p>Total Referrals: <span id="totalReferrals">0</span></p>
                    <p>Referral Rewards: <span id="referralRewards">0</span> USDC</p>
                </div>
            </div>
            <div class="card">
    <h3>Apply Referral Code</h3>
    <div class="input-group">
        <div class="input-wrapper">
            <input type="number" id="applyReferralCode" placeholder="Enter Referral Code">
        </div>
        <button id="applyReferralButton" class="button">Apply Referral</button>
    </div>
</div>

 <div class="card">
    <h3>Stake USDC</h3>
    <div class="input-group">
        <div class="input-wrapper">
            <input type="number" id="stakeAmount" class="with-max" placeholder="Amount" step="0.01" min="0.01">
            <button class="max-button" id="maxStakeButton">MAX</button>
        </div>
        <button id="stakeButton" class="button">Stake USDC</button>
    </div>
</div>

            <div class="card">
                <h3>Manage Stake</h3>
                <div class="input-group">
                    <input type="number" id="withdrawAmount" placeholder="Amount" step="0.01" min="0.01">
                    <button id="withdrawButton" class="button secondary">Withdraw</button>
                    <button id="claimRewardsButton" class="button secondary">Claim Rewards</button>
                </div>
            </div>

            <div class="card">
                <h3>Referral Program</h3>
                <button id="generateReferralCode" class="button">Generate Referral Code</button>
                <p>Your Referral Code: <span id="yourReferralCode">-</span></p>
                <p>Referral Rewards: <span id="referralRewards">0</span> USDC</p>
                <button id="claimReferralRewards" class="button secondary">Claim Referral Rewards</button>
            </div>
        </div>
    </div>

    <script>
    // Global Constants
const CONTRACT_ADDRESS = '0x2Bd38bD63D66b360dE91E2F8CAEe48AA0B159a00';
    const USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
    const BASE_CHAIN_ID = '0x2105';
    const DEBUG_MODE = true;

        async function getOptimalGasPrice() {
    const currentGasPrice = await web3.eth.getGasPrice();
    return Math.floor(currentGasPrice * 1.85).toString(); // 85%バッファー
}
        
    // Global Variables
    let web3;
    let contract;
    let usdcContract;
    let userAddress;

    // USDC Token ABI Definition
    const USDC_ABI = [
        {
            "inputs": [
                {"name": "spender","type": "address"},
                {"name": "amount","type": "uint256"}
            ],
            "name": "approve",
            "outputs": [{"name": "","type": "bool"}],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {"name": "owner","type": "address"},
                {"name": "spender","type": "address"}
            ],
            "name": "allowance",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {"name": "account","type": "address"}
            ],
            "name": "balanceOf",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        }
    ];

    // Main Contract ABI Definition
    const CONTRACT_ABI = [
        {
            "inputs": [{"name": "","type": "address"}],
            "name": "deposits",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [{"name": "","type": "address"}],
            "name": "calculateReward",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {"name": "amount","type": "uint256"},
                {"name": "referralCode","type": "uint256"}
            ],
            "name": "depositFunds",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [{"name": "amount","type": "uint256"}],"name": "withdraw",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "claimDepositReward",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "claimReferralReward",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [{"name": "user","type": "address"}],
            "name": "getUserInfo",
            "outputs": [
                {"name": "depositAmount","type": "uint256"},
                {"name": "pendingRewards","type": "uint256"},
                {"name": "userReferralRewards","type": "uint256"},
                {"name": "totalReferrals","type": "uint256"},
                {"name": "isFrozen","type": "bool"}
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [{"name": "","type": "address"}],
            "name": "referralRewards",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
        "inputs": [
            {"name": "referralCode", "type": "uint256"}
        ],
        "name": "processReferral",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
        {
            "inputs": [],
            "name": "generateReferralCode",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [{"name": "","type": "address"}],
            "name": "userToReferralCode",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [{"name": "","type": "address"}],
            "name": "userToReferrer",
            "outputs": [{"name": "","type": "address"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": true,
                    "name": "user",
                    "type": "address"
                },
                {
                    "indexed": false,
                    "name": "referralCode",
                    "type": "uint256"
                }
            ],
            "name": "ReferralCodeCreated",
            "type": "event"
        },
        {
            "inputs": [],
            "name": "currentAPR",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "referrerRewardRate",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "referredRewardRate",
            "outputs": [{"name": "","type": "uint256"}],
            "stateMutability": "view",
            "type": "function"
        }
    ];

    // Utility Functions
    function showDebugInfo(info) {
        if (!DEBUG_MODE) return;
        const debugDiv = document.getElementById('debugInfo');
        debugDiv.style.display = 'block';
        debugDiv.innerHTML += `<div>[${new Date().toISOString()}] ${info}</div>`;
        debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.className = `alert ${type}`;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

function formatNumber(number, decimals = 6) {
    const num = typeof number === 'string' ? number : number.toString();
    if (num === '0') {
        return '0.' + '0'.repeat(decimals);
    }
    const parts = num.split('.');
    if (parts.length === 1) {
        return parts[0] + '.' + '0'.repeat(decimals);
    }
    const decimal = parts[1].padEnd(decimals, '0').slice(0, decimals);
    return parts[0] + '.' + decimal;
}
    async function updatePlatformInfo() {
        try {
            if (!contract) {
                showDebugInfo('Contract not initialized for platform info update');
                return;
            }

            const apr = await contract.methods.currentAPR().call();
            const referrerRate = await contract.methods.referrerRewardRate().call();
            const referredRate = await contract.methods.referredRewardRate().call();
            
            document.getElementById('currentAPR').textContent = (apr / 100).toFixed(2);
            document.getElementById('referrerReward').textContent = (referrerRate / 100).toFixed(2);
            document.getElementById('referredReward').textContent = (referredRate / 100).toFixed(2);
            
            showDebugInfo('Platform info updated successfully');
        } catch (error) {
            console.error('Error updating platform info:', error);
            showDebugInfo('Platform info update error: ' + error.message);
        }
    }

    // Web3 Initialization
    async function initWeb3() {
        if (window.ethereum) {
            try {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                usdcContract = new web3.eth.Contract(USDC_ABI, USDC_ADDRESS);
                
                await updatePlatformInfo();
                
         // initWeb3 関数内のイベントリスナー設定部分を以下のように変更
document.getElementById('connectWallet').addEventListener('click', connectWallet);
document.getElementById('stakeButton').addEventListener('click', stake);
document.getElementById('withdrawButton').addEventListener('click', withdraw);
document.getElementById('claimRewardsButton').addEventListener('click', claimRewards);
document.getElementById('generateReferralCode').addEventListener('click', generateReferralCode);
document.getElementById('claimReferralRewards').addEventListener('click', claimReferralRewards);
document.getElementById('maxStakeButton').addEventListener('click', setMaxStakeAmount);
document.getElementById('applyReferralButton').addEventListener('click', applyReferral);

                setInterval(updatePlatformInfo, 15 * 60 * 1000);

                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    onConnect();
                }

                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);

                checkNetwork();
                showDebugInfo('Web3 initialized successfully');
            } catch (error) {
                console.error("Error initializing Web3:", error);
                showAlert('Failed to initialize Web3: ' + error.message, 'error');
                showDebugInfo('Web3 initialization error: ' + error.message);
            }
        } else {
            showAlert('Please install MetaMask!', 'error');
            showDebugInfo('MetaMask not found');
        }
    }


    async function connectWallet() {
        if (!window.ethereum) {
            showAlert('Please install MetaMask!', 'error');
            return;
        }

        try {
            showLoading(true);
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            userAddress = accounts[0];
            showDebugInfo('Wallet connected: ' + userAddress);
            
            await checkAndSwitchNetwork();
            
            onConnect();
            showAlert('Wallet connected successfully!', 'success');
        } catch (error) {
            console.error("Connection error:", error);
            showAlert('Failed to connect wallet: ' + error.message, 'error');
            showDebugInfo('Wallet connection error: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
            userAddress = null;
            document.getElementById('connectWallet').textContent = 'Connect Wallet';
            document.getElementById('mainContent').style.display = 'none';
              document.getElementById('landingContent').style.display = 'block'; // 追加
            updateNetworkStatus(false);
            showDebugInfo('Wallet disconnected');
        } else if (accounts[0] !== userAddress) {
            userAddress = accounts[0];
            onConnect();
            showDebugInfo('Account changed to: ' + userAddress);
        }
    }

    function handleChainChanged(chainId) {
        showDebugInfo('Chain changed to: ' + chainId);
        if (chainId !== BASE_CHAIN_ID) {
            showAlert('Please switch to BASE Network', 'error');
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('landingContent').style.display = 'block'; // 追加
            updateNetworkStatus(false);
        } else {
            document.getElementById('mainContent').style.display = 'block';
              document.getElementById('landingContent').style.display = 'none'; // 追加
            updateNetworkStatus(true);
            updateUI();
        }
    }

    async function checkNetwork() {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        showDebugInfo('Current chain ID: ' + chainId);
        updateNetworkStatus(chainId === BASE_CHAIN_ID);
        return chainId === BASE_CHAIN_ID;
    }

    function updateNetworkStatus(isCorrect) {
        const status = document.getElementById('networkStatus');
        if (isCorrect) {
            status.textContent = 'BASE Network';
            status.className = 'network-status correct';
        } else {
            status.textContent = 'Wrong Network';
            status.className = 'network-status wrong';
        }
    }

    async function checkAndSwitchNetwork() {
        if (window.ethereum) {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== BASE_CHAIN_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base',
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        } catch (addError) {
                            showAlert('Failed to add BASE network', 'error');
                            showDebugInfo('Failed to add BASE network: ' + addError.message);
                            throw addError;
                        }
                    } else {
                        showAlert('Failed to switch to BASE network', 'error');
                        showDebugInfo('Failed to switch network: ' + error.message);
                        throw error;
                    }
                }
            }
            updateNetworkStatus(true);
        }
    }

 function onConnect() {
    document.getElementById('connectWallet').textContent = 
        `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('landingContent').style.display = 'none'; // 追加
    updateUI();
}

async function updateUI() {
    if (!userAddress) return;
    
    try {
        showLoading(true);
        
        // ブロック情報の取得
        const currentBlock = await web3.eth.getBlock('latest');
        showDebugInfo('=== Contract State ===');
        showDebugInfo(`Current Block Number: ${currentBlock.number}`);
        showDebugInfo(`Block Timestamp: ${currentBlock.timestamp}`);
        
        // ユーザー情報の取得
        const userInfo = await contract.methods.getUserInfo(userAddress).call();
        const balance = await usdcContract.methods.balanceOf(userAddress).call();
        
        showDebugInfo('\n=== User Info ===');
        showDebugInfo(`Deposit Amount: ${userInfo[0]}`); // depositAmount
        showDebugInfo(`Pending Rewards: ${userInfo[1]}`); // pendingRewards
        
        if (userInfo[0] > 0) {  // depositAmount > 0
            const apr = await contract.methods.currentAPR().call();
            
            showDebugInfo('\n=== Contract Parameters ===');
            showDebugInfo(`APR: ${apr/100}%`);
            showDebugInfo(`APR (raw): ${apr}`);
            showDebugInfo(`USDC_PRECISION: ${1000000}`);
            
            // BigNumber計算を使用して理論上の報酬を計算
            const yearInSeconds = web3.utils.toBN(365 * 24 * 60 * 60);
            const depositAmount = web3.utils.toBN(userInfo[0]);
            const aprBN = web3.utils.toBN(apr);
            
            const expectedDailyReward = depositAmount
                .mul(aprBN)
                .div(web3.utils.toBN(10000))
                .div(web3.utils.toBN(365));
                
            showDebugInfo('\n=== Reward Calculation ===');
            showDebugInfo(`Daily Rate: ${apr/10000/365}%`);
            showDebugInfo(`Expected Daily Reward: ${web3.utils.fromWei(expectedDailyReward, 'mwei')} USDC`);
            showDebugInfo(`Expected Daily Reward (raw): ${expectedDailyReward.toString()}`);
            
            const reward = await contract.methods.calculateReward(userAddress).call();
            showDebugInfo(`Actual Reward: ${web3.utils.fromWei(reward, 'mwei')} USDC`);
            showDebugInfo(`Actual Reward (raw): ${reward}`);
        }

        // Update all dashboard elements
        document.getElementById('userBalance').textContent = 
            formatNumber(web3.utils.fromWei(balance, 'mwei'));
        document.getElementById('stakedAmount').textContent = 
            formatNumber(web3.utils.fromWei(userInfo[0], 'mwei'));
        document.getElementById('pendingRewards').textContent = 
            formatNumber(web3.utils.fromWei(userInfo[1], 'mwei'));
        document.getElementById('totalReferrals').textContent = userInfo[3];
        document.getElementById('referralRewards').textContent = 
            formatNumber(web3.utils.fromWei(userInfo[2], 'mwei'));
            
        // Update referral code section visibility
        const referralCard = document.getElementById('applyReferralCode').closest('.card');
        if (await contract.methods.userToReferrer(userAddress).call() !== '0x0000000000000000000000000000000000000000') {
            referralCard.style.display = 'none';
            showDebugInfo('User already has a referrer - hiding referral input section');
        } else {
            referralCard.style.display = 'block';
            showDebugInfo('User has no referrer - showing referral input section');
        }

    } catch (error) {
        console.error('Error updating UI:', error);
        showAlert('Failed to update information', 'error');
        showDebugInfo('Error: ' + error.message);
    } finally {
        showLoading(false);
    }
}


async function stake() {
    if (!userAddress) return;
    
    const amount = document.getElementById('stakeAmount').value;
    if (!amount || amount <= 0) {
        showAlert('Please enter a valid amount', 'error');
        return;
    }

    try {
        showLoading(true);
        const amountWei = web3.utils.toWei(amount, 'mwei');
        showDebugInfo('Attempting to stake: ' + amount + ' USDC');

        // 承認状態の確認と承認処理
        const allowance = await usdcContract.methods.allowance(userAddress, CONTRACT_ADDRESS).call();
        if (web3.utils.toBN(allowance).lt(web3.utils.toBN(amountWei))) {
            showDebugInfo('Approval required. Processing approval...');
            showAlert('Approving USDC...', 'info');
            
            try {
                const approveTx = await usdcContract.methods.approve(CONTRACT_ADDRESS, amountWei)
                    .send({ 
                        from: userAddress,
                        gasPrice: await getOptimalGasPrice()
                    });
                showDebugInfo('Approval successful: ' + approveTx.transactionHash);
            } catch (approvalError) {
                throw new Error('Failed to approve USDC: ' + approvalError.message);
            }
        }

        // ステーク処理
        const tx = await contract.methods.depositFunds(amountWei, '0')
            .send({ 
                from: userAddress,
                gasPrice: await getOptimalGasPrice()
            });
        showAlert('Staking successful', 'success');
        showDebugInfo('Stake transaction: ' + tx.transactionHash);
        updateUI();
    } catch (error) {
        console.error('Transaction error:', error);
        let errorMessage = error.message;
        if (error.message.includes('paused')) {
            errorMessage = 'Staking is currently paused';
        } else if (error.message.includes('amount too low')) {
            errorMessage = 'Deposit amount is below minimum requirement';
        }
        showAlert('Failed to stake: ' + errorMessage, 'error');
        showDebugInfo('Stake error: ' + errorMessage);
    } finally {
        showLoading(false);
    }
}
    async function withdraw() {
        if (!userAddress) return;
        
        const amount = document.getElementById('withdrawAmount').value;
        if (!amount || amount <= 0) {
            showAlert('Please enter a valid amount', 'error');
            return;
        }

        // Get current staked amount first
            const userInfo = await contract.methods.getUserInfo(userAddress).call();
            const stakedAmount = web3.utils.fromWei(userInfo[0], 'mwei');
            
            // Validate withdrawal amount against staked balance
            if (parseFloat(amount) > parseFloat(stakedAmount)) {
                showAlert(`Cannot withdraw more than your staked balance of ${stakedAmount} USDC`, 'error');
                return;
            }

        try {
            showLoading(true);
            const amountWei = web3.utils.toWei(amount, 'mwei');
            showDebugInfo('Attempting to withdraw: ' + amount + ' USDC');
            
            const tx = await contract.methods.withdraw(amountWei)
                .send({ 
                    from: userAddress,
                    gasPrice: await getOptimalGasPrice()
                });
            showAlert('Withdrawal successful', 'success');
            showDebugInfo('Withdrawal transaction: ' + tx.transactionHash);
            updateUI();
        } catch (error) {
            console.error('Withdrawal error:', error);
            showAlert('Failed to withdraw: ' + error.message, 'error');
            showDebugInfo('Withdrawal error: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function claimRewards() {
    if (!userAddress) return;
    
    try {
        showLoading(true);
        
        // 事前に報酬額を確認
        const pendingRewards = await contract.methods.calculateReward(userAddress).call();
        showDebugInfo('Pending rewards amount: ' + web3.utils.fromWei(pendingRewards, 'mwei') + ' USDC');
        
        // ガス見積もり試行
        const gasEstimate = await contract.methods.claimDepositReward().estimateGas({
            from: userAddress
        }).catch(error => {
            showDebugInfo('Gas estimation failed: ' + error.message);
            throw error;
        });
        
        showDebugInfo('Estimated gas: ' + gasEstimate);
        
        // トランザクション実行
        const tx = await contract.methods.claimDepositReward()
            .send({ 
                from: userAddress,
                gas: Math.floor(gasEstimate * 1.2), // 20%のバッファを追加
                gasPrice: await getOptimalGasPrice()
            });
            
        showAlert('Rewards claimed successfully', 'success');
        showDebugInfo('Claim rewards transaction: ' + tx.transactionHash);
        updateUI();
    } catch (error) {
        console.error('Claim error:', error);
        let errorMessage = error.message;
        
        // エラーメッセージの詳細化
        if (error.message.includes('gas required exceeds allowance')) {
            errorMessage = 'Insufficient gas: The transaction requires more gas than expected';
        } else if (error.message.includes('execution reverted')) {
            errorMessage = 'Transaction reverted: You may not have any rewards to claim';
        }
        
        showAlert('Failed to claim rewards: ' + errorMessage, 'error');
        showDebugInfo('Claim rewards error: ' + errorMessage);
    } finally {
        showLoading(false);
    }
}

  async function generateReferralCode() {
        if (!userAddress) {
            showAlert('Please connect your wallet first', 'error');
            return;
        }
        
        try {
            showLoading(true);
            showDebugInfo('Attempting to generate referral code');

            const generateButton = document.getElementById('generateReferralCode');
            const existingCode = await contract.methods.userToReferralCode(userAddress).call();
            if (existingCode !== '0') {
                document.getElementById('yourReferralCode').textContent = existingCode;
                generateButton.style.display = 'none'; 
                showAlert('You already have a referral code', 'success');
                showDebugInfo('User already has referral code: ' + existingCode);
                return;
            }

            const tx = await contract.methods.generateReferralCode()
                .send({ 
                    from: userAddress,
                    gasPrice: await getOptimalGasPrice()
                });

            const event = tx.events.ReferralCodeCreated;
            if (event) {
                const generatedCode = event.returnValues.referralCode;
                document.getElementById('yourReferralCode').textContent = generatedCode;
                generateButton.style.display = 'none'; 
                showAlert('Referral code generated successfully', 'success');
                showDebugInfo('Generated referral code: ' + generatedCode);
            }

            updateUI();
        } catch (error) {
            console.error('Generate referral code error:', error);
            showAlert('Failed to generate referral code: ' + error.message, 'error');
            showDebugInfo('Generate referral code error: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

async function claimReferralRewards() {
    try {
        showLoading(true);
        showDebugInfo('Checking referral rewards amount');
        
        const rewardsAmount = await contract.methods.referralRewards(userAddress).call();
        
        if (web3.utils.toBN(rewardsAmount).isZero()) {
            showAlert('You currently have no referral rewards to claim', 'error');
            showDebugInfo('No referral rewards available');
            return;
        }

        if (web3.utils.fromWei(rewardsAmount, 'mwei') < 0.1) {
            showAlert('Please wait until your referral rewards reach 0.1 USDC before claiming to ensure the reward exceeds transaction fees', 'info');
            return;
        }
        
        showDebugInfo('Attempting to claim referral rewards: ' + web3.utils.fromWei(rewardsAmount, 'mwei') + ' USDC');
        
        const tx = await contract.methods.claimReferralReward()
            .send({ 
                from: userAddress,
                gasPrice: await getOptimalGasPrice()
            });
            
        showAlert('Referral rewards claimed successfully', 'success');
        showDebugInfo('Claim referral rewards transaction: ' + tx.transactionHash);
        updateUI();
    } catch (error) {
        console.error('Referral claim error:', error);
        
        // エラーメッセージをより分かりやすく変換
        let userFriendlyMessage = 'Unable to claim rewards. Please try again later.';
        if (error.message.includes('execution reverted')) {
            userFriendlyMessage = 'Transaction cannot be completed at this time. This might be due to network conditions or insufficient funds for transaction fees.';
        }
        
        showAlert(userFriendlyMessage, 'error');
        showDebugInfo('Claim referral rewards error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

        async function applyReferral() {
    if (!userAddress) return;
    
    const referralCode = document.getElementById('applyReferralCode').value;
    if (!referralCode) {
        showAlert('Please enter a valid referral code', 'error');
        return;
    }

    try {
        showLoading(true);
        showDebugInfo('Attempting to apply referral code: ' + referralCode);

        const tx = await contract.methods.processReferral(referralCode)
            .send({ 
                from: userAddress,
                gasPrice: await getOptimalGasPrice()
            });
            
        showAlert('Referral code applied successfully', 'success');
        showDebugInfo('Referral transaction: ' + tx.transactionHash);
        updateUI();
    } catch (error) {
        console.error('Referral error:', error);
        let errorMessage = error.message;
        if (error.message.includes('Already has referrer')) {
            errorMessage = 'You already have a referrer';
        } else if (error.message.includes('Must have active deposit')) {
            errorMessage = 'You need to make a deposit first';
        }
        showAlert('Failed to apply referral: ' + errorMessage, 'error');
        showDebugInfo('Referral error: ' + error.message);
    } finally {
        showLoading(false);
    }
}

    async function setMaxStakeAmount() {
        if (!userAddress) return;
        
        try {
            const balance = await usdcContract.methods.balanceOf(userAddress).call();
            const maxAmount = web3.utils.fromWei(balance, 'mwei');
            document.getElementById('stakeAmount').value = maxAmount;
            
  
        } catch (error) {
            console.error('Error setting max amount:', error);
            showDebugInfo('Error setting max amount: ' + error.message);
        }
    }

    window.addEventListener('load', initWeb3);

    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && userAddress) {
            updateUI();
            showDebugInfo('UI updated due to page visibility change');
        }
    });
    </script>
</body>
</html>
